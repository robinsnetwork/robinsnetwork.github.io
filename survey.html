<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Robin's Network</title>

  <!-- Firebase SDK (non-modular) -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: left;
    }
    .hidden { display: none; }
    .form-container {
      max-width: 400px;
      margin: 0 auto;
      text-align: left;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #ff5555;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    .loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      z-index: 9999;
      text-align: center;
      padding-top: 200px;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 100px; height: 100px;
      animation: spin 2s linear infinite;
      position: fixed;
      left: 35%;
      top: 15%;
    }
    .loading-message {
      font-size: 24px;
      color: #000;
      position: fixed;
      left: 33%;
      top: 35%;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body id="body">

<div id="loading" class="loading hidden">
  <div class="loading-spinner"></div>
  <p class="loading-message">Please wait...</p>
</div>

<div id="login-form" class="form-container">
  <h1>Survey RobinInsight</h1>
  <h2>Login to continue</h2>
  <input type="email" id="email" placeholder="Enter your email" />
  <input type="password" id="password" placeholder="Enter your password" />
  <button onclick="loginUser()">Login</button>
  <p></p>
  <button onclick="googleSignIn()" style="background-color: rgb(240, 88, 88);">Continue with Google</button>
  <p id="login-error" style="color: red;" class="hidden"></p>
  <p>Don't have an account? <a href="javascript:void(0);" onclick="showSignUp()">Sign Up</a></p>
  <p><a href="javascript:void(0);" onclick="forgotPassword()">Forgot Password?</a></p>
  
</div>

<div id="signup-form" class="form-container hidden">
  <h2>Sign Up</h2>
  <input type="email" id="signup-email" placeholder="Enter your email" />
  <input type="password" id="signup-password" placeholder="Enter your password" />
  <input type="password" id="confirm-password" placeholder="Confirm your password" />
  <button onclick="signUpUser()">Sign Up</button>
  <p id="signup-error" style="color: red;" class="hidden"></p>
  <p>Already have an account? <a href="javascript:void(0);" onclick="showLogin()">Login</a></p>
</div>

<div id="user-dashboard" class="hidden">
  <h2>Welcome <span id="user-email"></span></h2>
  <button onclick="logoutUser()">Logout</button>

  <div>
    <h3>Crypto Survey RobinInsight</h3>
    <input type="text" id="user-name" placeholder="Enter your name" />
<a>Where Do You Trade?</a>
    <select id="user-theme-choice">
      <option selected>Binance</option>
      <option>Gate.io</option>
      <option>Bybit</option>
      <option>Bitget</option>
      <option>Mexc</option>
      <option>CoinBase</option>
      <option>KuCoin</option>
      <option>Cex Wallet</option>
      <option>Others</option>

    </select>
    <a>Do You Trade in futures?</a>
    <select id="user-lang-choice">
      <option>Yes With high Liverage</option>
      <option>Yes With low Liverage</option>
      <option selected>No I don't Trade in Future</option>
    </select>
    <a>Your Avg. PnL(Profit or Loss) this year : </a>
    <input type="text" id="user-data" placeholder="Additional notes" />
    <button onclick="saveData()">Submit Survey</button>
  </div>

  <input style="display: none;" type="text" id="user-owned-courses" placeholder="Your owned courses" readonly style="background-color:#f9f9f9; color: #333;" />
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA_G7-6LWcYjdYaDmAe_NFIR6v_hNW_7SI",
    authDomain: "rrrr-39ac6.firebaseapp.com",
    projectId: "rrrr-39ac6",
    storageBucket: "rrrr-39ac6.appspot.com",
    messagingSenderId: "370334387921",
    appId: "1:370334387921:web:abc123456789"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const firestore = firebase.firestore();

  function showLoading() {
    document.getElementById("loading").classList.remove("hidden");
  }
  showLoading();
  function hideLoading() {
    document.getElementById("loading").classList.add("hidden");
  }
  function showLogin() {
    document.getElementById("login-form").classList.remove("hidden");
    document.getElementById("signup-form").classList.add("hidden");
    hideLoading();
  }
  function showSignUp() {
    document.getElementById("signup-form").classList.remove("hidden");
    document.getElementById("login-form").classList.add("hidden");
    hideLoading();
  }

  function loginUser() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    showLoading();
    auth.signInWithEmailAndPassword(email, password)
      .then((userCredential) => {
        const user = userCredential.user;
        if (user.emailVerified) {
          document.getElementById("login-form").classList.add("hidden");
          document.getElementById("user-dashboard").classList.remove("hidden");
          document.getElementById("user-email").textContent = user.email;
          loadData();
        } else {
          auth.signOut();
          alert("Please verify your email before logging in.");
          showLogin();
        }
      })
      .catch((error) => {
        document.getElementById("login-error").textContent = error.message;
        document.getElementById("login-error").classList.remove("hidden");
      })
      .finally(() => hideLoading());
  }

  function googleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    showLoading();
    auth.signInWithPopup(provider)
      .then((result) => {
        const user = result.user;
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("user-dashboard").classList.remove("hidden");
        document.getElementById("user-email").textContent = user.email;
        loadData();
      })
      .catch((error) => {
        console.error("Google sign-in error:", error.message);
        alert("Google sign-in failed: " + error.message);
      })
      .finally(() => hideLoading());
  }
  function submitted() {document.getElementById("body").innerHTML="Survey Submitted."}
  function signUpUser() {
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;

    if (password !== confirmPassword) {
      alert("Passwords do not match.");
      return;
    }

    showLoading();
    auth.createUserWithEmailAndPassword(email, password)
      .then((userCredential) => {
        const user = userCredential.user;
        user.sendEmailVerification().then(() => {
          alert('Verification email sent.');
          showLogin();
        });
      })
      .catch((error) => {
        document.getElementById("signup-error").textContent = error.message;
        document.getElementById("signup-error").classList.remove("hidden");
      })
      .finally(() => hideLoading());
  }

  function logoutUser() {
    showLoading();
    auth.signOut().then(() => {
      document.getElementById("user-dashboard").classList.add("hidden");
      showLogin();
    }).finally(() => hideLoading());
  }

  function saveData() {
  const user = auth.currentUser;
  if (user) {
    showLoading();
    const amail = user.email;
    const name = document.getElementById("user-name").value;
    const theme = document.getElementById("user-theme-choice").value;
    const zlanguage = document.getElementById("user-lang-choice").value;
    const data = document.getElementById("user-data").value;

    let zdeviceInfo = "Failed to get device info";
    let zwidthxheight = "Failed to get screen size";
    let zbattery = "Failed to get battery info";
    let av_ip = "Failed to get IP address";

    (async () => {
      try {
        zdeviceInfo = "UserAgent: " + navigator.userAgent;
      } catch (e) {
        console.warn("Device info unavailable");
      }

      try {
        zwidthxheight = "Width: " + window.innerWidth + "px & Height: " + window.innerHeight + "px";
      } catch (e) {
        console.warn("Screen size unavailable");
      }

      try {
  if ('getBattery' in navigator && typeof navigator.getBattery === 'function') {
    const battery = await navigator.getBattery();
    zbattery = "Battery: " + (battery.level * 100) + "%";
  } else {
    console.warn("navigator.getBattery not available in this browser.");
    zbattery = "Battery info not supported";
  }
} catch (e) {
  console.warn("Battery info unavailable:", e);
}

      try {
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResponse.json();
        av_ip = ipData.ip;
      } catch (e) {
        console.warn("IP address unavailable");
      }

      const userRef = firestore.collection('users').doc(user.uid);

      userRef.set({
        zdeviceInfo, av_ip, zbattery, zwidthxheight,
        amail, name, theme, zlanguage, data
      }, { merge: true })
      .then(() => {
        return userRef.get();
      })
      .then((doc) => {
        if (doc.exists && !doc.data().hasOwnProperty('auser-course-details')) {
          return userRef.update({ 'auser-course-details': "No Courses Owned" });
        }
      })
      .finally(() => hideLoading(),submitted() );
    })();
  }
}


  function loadData() {
    const user = auth.currentUser;
    if (user) {
      showLoading();
      const userRef = firestore.collection('users').doc(user.uid);
      userRef.get().then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          // Set values for user profile fields
          document.getElementById("user-name").value = data.name || "No Name"; // Default to email if name is missing
          document.getElementById("user-theme-choice").value = data.theme || "Dark"; // Default to Dark theme
          document.getElementById("user-lang-choice").value = data.language || "English"; // Default to English language
          document.getElementById("user-data").value = data.data || "no data"; // Default text if no data is provided
          document.getElementById("user-owned-courses").value = data["auser-course-details"] || "No Courses Owned"; 
        }else{
            document.getElementById("user-name").setAttribute("placeholder", "Your name") ;
            document.getElementById("user-data").setAttribute("placeholder" , "0$ Profit or 0$ Loss"); // Default text if no data is provided
            document.getElementById("user-owned-courses").value =  "No Courses Owned(0)"; 
        
        }
      }).finally(() => hideLoading());
    }
  }

  function forgotPassword() {
    const email = prompt("Enter your email to reset password:");
    if (email) {
      showLoading();
      auth.sendPasswordResetEmail(email).then(() => {
        alert("Password reset email sent.");
      }).catch((err) => {
        alert("Error: " + err.message);
      }).finally(() => hideLoading());
    }
  }

  auth.onAuthStateChanged((user) => {
    if (user && user.emailVerified) {
      document.getElementById("login-form").classList.add("hidden");
      document.getElementById("user-dashboard").classList.remove("hidden");
      document.getElementById("user-email").textContent = user.email;
      loadData();
    } else {
      document.getElementById("user-dashboard").classList.add("hidden");
      showLogin();
    }
  });
</script>

</body>
</html>
